@{
    ViewData["Title"] = "Upload Document";
}

<div style="margin-bottom: 30px;">
    <h2>Upload Document</h2>
</div>

<sl-card style="max-width: 700px; margin: 20px 0;">
    <form asp-action="Upload" method="post" enctype="multipart/form-data" id="uploadForm">
        @Html.AntiForgeryToken()
        
        <div style="margin-bottom: 25px;">
            <label for="title">
                <strong>Document Title</strong>
                <span style="color: red;">*</span>
            </label>
            <sl-input 
                id="title" 
                name="title" 
                placeholder="e.g., Emerald Eyes - Book 1" 
                required 
                style="margin-top: 5px;">
            </sl-input>
        </div>
        
        <div style="margin-bottom: 25px;">
            <label for="subtype">
                <strong>Document Type</strong>
                <span style="color: red;">*</span>
            </label>
            <sl-select 
                id="subtype" 
                name="subtype" 
                value="Book"
                required
                style="margin-top: 5px;">
                <sl-option value="Book">Book</sl-option>
                <sl-option value="Notes">Notes</sl-option>
                <sl-option value="Outline">Outline</sl-option>
                <sl-option value="Appendix">Appendix</sl-option>
            </sl-select>
            <sl-tooltip content="Choose the type that best describes this document.">
                <sl-icon-button name="info-circle" label="Info" style="margin-left: 10px;"></sl-icon-button>
            </sl-tooltip>
            <div style="font-size: 13px; color: #666; margin-top: 5px;">
                Choose the type that best describes this document
            </div>
        </div>
        
        <div style="margin-bottom: 25px;">
            <label for="seriesName">
                <strong>Series Name</strong>
                <span style="font-size: 13px; color: #666;">(optional)</span>
            </label>
            <sl-input 
                id="seriesName" 
                name="seriesName" 
                placeholder="e.g., The Evermore Chronicles"
                style="margin-top: 5px;">
            </sl-input>
        </div>
        
        <div style="margin-bottom: 25px;">
            <label for="bookNumber">
                <strong>Book Number</strong>
                <span style="font-size: 13px; color: #666;">(optional)</span>
            </label>
            <sl-input 
                id="bookNumber" 
                name="bookNumber" 
                type="number"
                min="1"
                placeholder="e.g., 1"
                style="margin-top: 5px;">
            </sl-input>
        </div>
        
        <div style="margin-bottom: 25px;">
            <label>
                <strong>Upload File</strong>
                <span style="color: red;">*</span>
            </label>
            <div style="font-size: 13px; color: #666; margin-top: 5px; margin-bottom: 10px;">
                Supported formats: .txt, .md (max 10MB)
            </div>
            
            <div id="dropZone" role="button" tabindex="0" aria-label="Drop file here or press Enter to browse" style="
                border: 2px dashed #cbd5e0;
                border-radius: 8px;
                padding: 40px;
                text-align: center;
                background: #f8fafc;
                cursor: pointer;
                transition: all 0.2s;
                margin-top: 10px;">
                <sl-icon name="cloud-upload" style="font-size: 48px; color: #667eea; margin-bottom: 15px;"></sl-icon>
                <div style="font-size: 16px; margin-bottom: 10px;">
                    <strong>Drop your file here</strong> or click to browse
                </div>
                <div style="font-size: 14px; color: #666;">
                    .txt or .md files up to 10MB
                </div>
                <input 
                    type="file" 
                    id="file" 
                    name="file" 
                    accept=".txt,.md"
                    required
                    style="display: none;">
            </div>
            
            <div id="fileInfo" style="display: none; margin-top: 15px; padding: 15px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <sl-icon name="file-earmark-text" style="font-size: 24px; color: #667eea;"></sl-icon>
                    <div style="flex: 1;">
                        <div id="fileName" style="font-weight: 600; margin-bottom: 3px;"></div>
                        <div id="fileSize" style="font-size: 13px; color: #666;"></div>
                    </div>
                    <sl-icon-button name="x-circle" label="Remove" id="removeFile" style="font-size: 20px;"></sl-icon-button>
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 25px; padding: 15px; background: #fef3c7; border: 1px solid #fde68a; border-radius: 6px;">
            <div style="display: flex; align-items: start; gap: 10px;">
                <sl-checkbox id="startIngestion" name="startIngestion" value="true" style="margin-top: 2px; cursor: pointer; font-weight: 600;">
                    Start ingestion immediately
                </sl-checkbox>
                <div style="font-size: 13px; color: #666; margin-top: 5px;">
                    Automatically process this document to extract entities, assertions, and relationships. 
                    This may take several minutes depending on document size.
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <sl-button type="submit" variant="primary" id="submitBtn">
                <sl-icon slot="prefix" name="cloud-upload"></sl-icon>
                Upload Document
            </sl-button>
            <sl-button href="/documents" variant="default">
                Cancel
            </sl-button>
        </div>
    </form>
</sl-card>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const KB_TO_BYTES = 1024;
        const MB_TO_BYTES = 1024 * 1024;
        const MAX_FILE_SIZE_MB = 10;
        const ALLOWED_EXTENSIONS = ['.txt', '.md'];
        
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('file');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFile = document.getElementById('removeFile');
        const uploadForm = document.getElementById('uploadForm');
        const submitBtn = document.getElementById('submitBtn');

        // Validate file before displaying
        function validateFile(file) {
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            if (!ALLOWED_EXTENSIONS.includes(ext)) {
                alert('Only .txt and .md files are supported.');
                return false;
            }
            if (file.size > MAX_FILE_SIZE_MB * MB_TO_BYTES) {
                alert('File size must not exceed 10MB.');
                return false;
            }
            return true;
        }

        // Click to browse (only when file info is not visible)
        dropZone.addEventListener('click', (event) => {
            const isFileInfoVisible = window.getComputedStyle(fileInfo).display !== 'none';
            if (!isFileInfoVisible) {
                fileInput.click();
            }
        });

        // Keyboard navigation support for drop zone
        dropZone.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const isFileInfoVisible = window.getComputedStyle(fileInfo).display !== 'none';
                if (!isFileInfoVisible) {
                    fileInput.click();
                }
            }
        });

        // Drag and drop handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#667eea';
            dropZone.style.background = '#eef2ff';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = '#cbd5e0';
            dropZone.style.background = '#f8fafc';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#cbd5e0';
            dropZone.style.background = '#f8fafc';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (!validateFile(file)) {
                    return;
                }
                
                // Set the file input's files with better browser compatibility
                try {
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    fileInput.files = dt.files;
                } catch (err) {
                    // Fallback for browsers that don't support DataTransfer
                    console.warn('DataTransfer not supported, file input may not be set correctly');
                }
                
                displayFileInfo(file);
            }
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                if (validateFile(file)) {
                    displayFileInfo(file);
                } else {
                    // Clear the file input if validation fails
                    fileInput.value = '';
                }
            }
        });

        // Display file info
        function displayFileInfo(file) {
            const sizeKB = (file.size / KB_TO_BYTES).toFixed(2);
            const sizeMB = (file.size / MB_TO_BYTES).toFixed(2);
            const sizeDisplay = file.size > MB_TO_BYTES ? `${sizeMB} MB` : `${sizeKB} KB`;
            
            fileName.textContent = file.name;
            fileSize.textContent = sizeDisplay;
            
            dropZone.style.display = 'none';
            fileInfo.style.display = 'block';
        }

        // Remove file
        removeFile.addEventListener('click', () => {
            fileInput.value = '';
            dropZone.style.display = 'block';
            fileInfo.style.display = 'none';
        });

        // Form submit with validation and loading state
        uploadForm.addEventListener('submit', function(e) {
            // Ensure a file is selected before allowing submission
            if (!fileInput.files || fileInput.files.length === 0) {
                e.preventDefault();

                // Trigger native validation UI if available
                if (typeof uploadForm.reportValidity === 'function') {
                    uploadForm.reportValidity();
                }

                return;
            }
            submitBtn.loading = true;
            submitBtn.disabled = true;
        });
    });
</script>
